---
title: "DGE"
format: html
editor: source
author: viv3kanand
date: "`r format(Sys.time(), '%d %B, %Y')`"
---

```{r}
require(Seurat)
require(DESeq2)
require(tidyverse)
```

## Bulk

```{r}
count_bulk <- read_csv("../data/Bulk/FRDA_bulk_counts.csv") |> 
  dplyr::distinct(Gene, .keep_all = TRUE) |> 
  tibble::column_to_rownames("Gene")

meta_bulk <- read_csv("../data/Bulk/Metadata_bulk.csv") |> 
  tibble::column_to_rownames("SampleID")

identical(colnames(count_bulk), rownames(meta_bulk))
```

## Single cell

### Load data

```{r}
#| label: load data
#| echo: true
#| eval: false

seu_WB <- read_rds(paste0("RData/", Sys.Date(), "_seurat_WB.rds"))
seu_PBMC <- read_rds(paste0("RData/", Sys.Date(), "_seurat_PBMC.rds"))

DefaultAssay(seu_WB) <- "RNA"
Idents(seu_WB) <- "cell_type"

DefaultAssay(seu_PBMC) <- "RNA"
Idents(seu_PBMC) <- "cell_type"

```

### PBMC - Pseudobulk

#### FRDA vs Control

```{r}
bulk <- AggregateExpression(merged_data,
                            return.seurat = TRUE, #aggregated values are placed in the 'counts' layer
                            assays = "RNA", 
                            group.by = c("orig.ident", "cell_type", "Condition"))


DGE_bulk <- lapply(
  setNames(unique(bulk$cell_type), unique(bulk$cell_type)), function(celltype) {
    subset.bulk <- subset(bulk, cell_type == celltype)
    Idents(subset.bulk) <- "Condition"
    de_markers <- FindMarkers(subset.bulk, 
                              ident.1 = "FRDA",
                              ident.2 = "Control", 
                              slot = "counts", 
                              test.use = "DESeq2",
                              verbose = TRUE) |> 
      rownames_to_column(var = "gene") |> 
      left_join(y = unique(annotations[, c("gene_name", "description")]),
               by = c("gene" = "gene_name"))
    
    return(de_markers)
})

write_rds(DGE_bulk, "RData/DGE_bulk_res_1.rds")
```










