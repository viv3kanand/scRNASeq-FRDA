---
title: "Figures"
format: html
editor: source
author: viv3kanand
---

## Install packages

```{r}
#| label: install
#| echo: true
#| eval: false
options(renv.config.pak.enabled = TRUE)

renv::install("scCustomize")
renv::install("MetBrewer")
renv::install("ggpointdensity")
renv::install("Bioc::dittoSeq")

```


## Load libraries

```{r}
#| label: packages
#| echo: true
#| eval: true
#| message: false
#| warning: false

require(Seurat)
require(DropletUtils)
require(tidyverse)
require(MetBrewer)
require(ggpointdensity)
# require(scico)
require(scCustomize)

```

### Load data

```{r}
#| label: load data
#| echo: false
#| eval: true

seu_PBMC <- read_rds("../data/2024-11-22_seurat_obj_PBMC.rds")
seu_WB <- read_rds("../data/2024-10-17_seurat_obj_WB.rds")
```

## Load data

```{r}
#| label: load data
#| echo: true
#| eval: false

seu_WB <- read_rds(paste0("RData/", Sys.Date(), "_seurat_WB.rds"))
seu_PBMC <- read_rds(paste0("RData/", Sys.Date(), "_seurat_PBMC.rds"))

```

## Helper scripts

```{r}
#| label: source helper scripts
#| echo: true
#| eval: true

source("../scripts/helper_scripts.R")

```

## QC

### Library saturation

```{r}
#| label: saturation
#| echo: true
#| eval: true
#| fig-width: 10
#| fig-height: 7
#| fig-align: center

ggplot(seurat_list$C2_Control@meta.data, aes(nCount_RNA, nFeature_RNA)) +
    geom_bin2d(bins = 50) +
    MetBrewer::scale_fill_met_c(palette = "Hiroshige", direction = -1) +
    scale_x_log10(guide = "axis_logticks") + scale_y_log10(guide = "axis_logticks") +
    labs(x = "Total UMI counts", y = "Number of genes detected")

```

### Knee plot

```{r}
#| label: knee plot
#| echo: true
#| eval: true
#| fig-width: 10
#| fig-height: 7
#| fig-align: center

knee_plot(barcodeRanks(seurat_list$C2_Control[["RNA"]]$counts, lower = 10))

```


```{r}
ggplot(seurat_obj@meta.data, aes(nCount_RNA, percent.mt)) +
  geom_pointdensity() +
  scale_color_scico(palette = "devon", direction = -1, end = 0.9) +
  labs(x = "Total UMI counts", y = "Percentage mitochondrial")

```


```{r}
p1 <- seurat_obj@meta.data |> 
    ggplot(aes(color = Condition, x = nFeature_RNA  , fill = Condition)) + 
    geom_density(alpha = 0.2) + 
    scale_x_log10() + 
    theme_classic() +
    ylab("Density") +
    geom_vline(xintercept = 500)

p2 <- seurat_obj@meta.data |> 
    ggplot(aes(color = Condition, x = nCount_RNA , fill = Condition)) + 
    geom_density(alpha = 0.2) + 
    scale_x_log10() + 
    theme_classic() +
    ylab("Density") +
    geom_vline(xintercept = 500)

p3 <- seurat_obj@meta.data |> 
    ggplot(aes(color = Condition, x = percent.mt, fill = Condition)) + 
    geom_density(alpha = 0.2) + 
    #scale_x_log10() + 
    theme_classic() +
    geom_vline(xintercept = c(5, 10))

p4 <- FeatureScatter(seurat_obj, feature1 = "nCount_RNA", feature2 = "nFeature_RNA") & NoLegend()

p1 + p2 + p3 + p4
```

<!-- Todo list -->

<!-- Panel 1: Bulk RNAseq: PCA plot, Volcano plot, GO/KEGG plot, Heatmap of immune system/neutrophil related genes -->
<!-- Panel 2: WGCNA- bulk, IPA module 3: Tom plot, heatmap, Module eigenvector plot with significance, Module 3 IPA Top 20 pathway plot  -->
<!-- Panel 3: scRNAseq- PBMC (WB data in supplementary)- UMAPs, marker dot plot, DCAT proportions, DEG-upset plot (all cell types) -->

```{r}
# Whole blood

DimPlot(seu_WB, 
        reduction = "umap.harmony", 
        group.by = c("cell_type"), 
        pt.size = 0.5, 
        label = TRUE, 
        label.size = 5,
        cols = paletteer::paletteer_d("ggthemes::Tableau_20")) & 
  labs(title = NULL, x = "UMAP1", y = "UMAP2") &
  NoLegend() &
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank())

```


<!-- Panel 4: CD14 monocytes-immunomodulation: imbalance score, Volcano plot of DEGs, pathway analysis (GSEA KEGG, BP), CS-score, Cell Chat, , TF analysis -->
<!-- Panel 5: IL-10 producing monocytes: Il-10 levels in FA vs HC, IL-10 pathway genes (Reactome) heatmap, IL-10 producing cells proportion -->
<!-- Panel 6: Neutrophils-IFN signaling: Metascape results, IFN pathway gene heatmap/scores Neutrophil degranulation pathway genes heatmap/ pathway scores, TF-STAT1 signaling, PRR pathway score -->
<!-- Panel 7: Monocyte IL-10- Neutrophil IFN axis associated with cardiomyopathy: WGCNA (bulk)- cardiac hypertrophy/ IL-10 signaling genes; Il-10 levels in CAD vs NCAD, NLR ratio in CAD vs NCAD, Neutrophil genes- KLF2- cardiomyopathy -->















