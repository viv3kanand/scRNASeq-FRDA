---
title: "Figures"
format: html
editor: source
author: viv3kanand
---

## Install packages

```{r}
#| label: install
#| echo: true
#| eval: false
options(renv.config.pak.enabled = TRUE)

renv::install("ggpointdensity")
renv::install("paletteer")

```


## Load libraries

```{r}
#| label: packages
#| echo: true
#| eval: true
#| message: false
#| warning: false

require(Seurat)
require(DropletUtils)
require(tidyverse)
require(ggpointdensity)
# require(scico)

```

### Load data

```{r}
#| label: load data
#| echo: false
#| eval: true

seu_PBMC <- read_rds("../data/2024-11-22_seurat_obj_PBMC.rds")
seu_WB <- read_rds("../data/2024-10-17_seurat_obj_WB.rds")

DefaultAssay(seu_WB) <- "RNA"
Idents(seu_WB) <- "cell_type"

DefaultAssay(seu_PBMC) <- "RNA"
Idents(seu_PBMC) <- "cell_type"
```

## Load data

```{r}
#| label: load data
#| echo: true
#| eval: false

seu_WB <- read_rds(paste0("RData/", Sys.Date(), "_seurat_WB.rds"))
seu_PBMC <- read_rds(paste0("RData/", Sys.Date(), "_seurat_PBMC.rds"))

DefaultAssay(seu_WB) <- "RNA"
Idents(seu_WB) <- "cell_type"

DefaultAssay(seu_PBMC) <- "RNA"
Idents(seu_PBMC) <- "cell_type"

```

## Helper scripts

```{r}
#| label: source helper scripts
#| echo: true
#| eval: true

source("../scripts/helper_scripts.R")

```

### Custom theme to apply

```{r}
# Theme elements
font <- "Helvetica"
text_size <- 10
line_size <- 0.5

# Figure elements
res <- 300
full_width <- 10
full_height <- 13
meas_units <- "in"
output_filetype <- "png"
fig_lab_size <- 9
fig_lab_pos_x <- 0
fig_lab_pos_y <- 1
label_type <- "AUTO"

custom_theme <- function(){
  theme_classic() +
    theme(text = element_text(family = font,
                              size = text_size),
          line = element_line(linewidth = line_size),
          legend.title = element_text(size = rel(1.5)),
          
          axis.title = element_text(size = rel(1.5)),
          axis.text = element_text(size = rel(1.15)),
          plot.title = element_text(size = rel(1.5),
                                    hjust = 0.5),
          panel.grid = element_blank(),
          plot.background = element_rect(fill = "white"),
          legend.position = "right",
          legend.text=element_text(size = text_size))
}

empty_axis <- function(){
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank())
}


umap_col <- paletteer::paletteer_d("ggthemes::Tableau_20")

palette1 <- c("#E64B35FF", "#417839FF")
palette2 <- c("#FF3D7FFF", "#3FB8AFFF")
palette3 <- c("#3A488AFF", "#BE3428FF") # paletteer_d("lisa::OskarSchlemmer")
palette4 <- c("#CF597EFF", "#009392FF") # paletteer_d("rcartocolor::Temps")
palette5 <- c("#CF597EFF", "#E9E29CFF", "#009392FF")

```

## QC

### Library saturation

```{r}
#| label: saturation
#| echo: true
#| eval: true
#| fig-width: 10
#| fig-height: 7
#| fig-align: center

ggplot(seurat_list$C2_Control@meta.data, aes(nCount_RNA, nFeature_RNA)) +
    geom_bin2d(bins = 50) +
    scico:: scale_fill_scico(palette = "davos", direction = -1) +
    scale_x_log10(guide = "axis_logticks") + scale_y_log10(guide = "axis_logticks") +
    labs(x = "Total UMI counts", y = "Number of genes detected")

```

### Knee plot

```{r}
#| label: knee plot
#| echo: true
#| eval: true
#| fig-width: 10
#| fig-height: 7
#| fig-align: center

knee_plot(barcodeRanks(seurat_list$C2_Control[["RNA"]]$counts, lower = 10))

```


```{r}
ggplot(seurat_obj@meta.data, aes(nCount_RNA, percent.mt)) +
  geom_pointdensity() +
  scale_color_scico(palette = "devon", direction = -1, end = 0.9) +
  labs(x = "Total UMI counts", y = "Percentage mitochondrial")

```


```{r}
p1 <- seurat_obj@meta.data |> 
    ggplot(aes(color = Condition, x = nFeature_RNA  , fill = Condition)) + 
    geom_density(alpha = 0.2) + 
    scale_x_log10() + 
    theme_classic() +
    ylab("Density") +
    geom_vline(xintercept = 500)

p2 <- seurat_obj@meta.data |> 
    ggplot(aes(color = Condition, x = nCount_RNA , fill = Condition)) + 
    geom_density(alpha = 0.2) + 
    scale_x_log10() + 
    theme_classic() +
    ylab("Density") +
    geom_vline(xintercept = 500)

p3 <- seurat_obj@meta.data |> 
    ggplot(aes(color = Condition, x = percent.mt, fill = Condition)) + 
    geom_density(alpha = 0.2) + 
    #scale_x_log10() + 
    theme_classic() +
    geom_vline(xintercept = c(5, 10))

p4 <- FeatureScatter(seurat_obj, feature1 = "nCount_RNA", feature2 = "nFeature_RNA") & NoLegend()

p1 + p2 + p3 + p4
```

<!-- Todo list -->

<!-- Panel 1: Bulk RNAseq: PCA plot, Volcano plot, GO/KEGG plot, Heatmap of immune system/neutrophil related genes -->
<!-- Panel 2: WGCNA- bulk, IPA module 3: Tom plot, heatmap, Module eigenvector plot with significance, Module 3 IPA Top 20 pathway plot  -->
<!-- Panel 3: scRNAseq- PBMC (WB data in supplementary)- UMAPs, marker dot plot, DCAT proportions, DEG-upset plot (all cell types) -->

```{r}
DefaultAssay(seu_WB) <- "RNA"
Idents(seu_WB) <- "cell_type"

DefaultAssay(seu_PBMC) <- "RNA"
Idents(seu_PBMC) <- "cell_type"


# Whole blood (Supplementary)

S1A <- DimPlot(seu_WB, 
               reduction = "umap.harmony", 
               group.by = c("cell_type"), 
               pt.size = 0.5, 
               label = TRUE, 
               label.size = 5,
               cols = umap_col) & 
  labs(title = NULL, x = "UMAP1", y = "UMAP2") &
  NoLegend() &
  custom_theme() +
  empty_axis()


markers_WB <- c("MKI67", "TOP2A", "CLEC4C", "NRP1", "FCER1A", "CLEC10A", "LYZ", "PPBP", "FCGR3A", "TNFRSF13B", "JCHAIN", "CD14", "KLRB1", "CD8A", "CD8B", "NKG7", "GNLY", "NCAM1", "CD79A", "MS4A1", "CD4", "CCR7", "ALPL", "MME")

S1B <- DotPlot(seu_WB, features = markers_WB) + 
  scale_colour_gradient2(low = "#FF8E7BFF", mid = 'white', high = "#009DBDFF") +
  RotatedAxis() +
  custom_theme() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

# Figure 3A - UMAP - PBMC

P3A <- DimPlot(seu_PBMC, 
               reduction = "umap.harmony", 
               group.by = c("cell_type"), 
               pt.size = 0.5,
               label = TRUE, 
               label.size = 5,
               raster = FALSE,
               cols = umap_col) & 
  labs(title = NULL, x = "UMAP1", y = "UMAP2") &
  NoLegend() &
  custom_theme() +
  empty_axis()
  

# Figure 3B - Marker genes - Dot plot

markers_PBMC <- c("CD34", "TNFRSF17", "LEF1", "CLEC4C", "NRP1", "KLRB1", "PTGDS", "FCER1A", "CLEC10A", "TNFRSF13B", "TRDC", "FCGR3A", "MS4A7", "PPBP", "CD8A", "CD79A", "MS4A1", "CCR7", "CCR4", "NKG7", "GNLY", "NCAM1", "CD14", "LYZ")

P3B <- DotPlot(seu_PBMC, features = markers_PBMC) + 
  scale_colour_gradient2(low = "#FF8E7BFF", mid = 'white', high = "#009DBDFF") +
  RotatedAxis() +
  custom_theme() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

# Figure 3C - Cell proportion

dcats_df <- run_dcats(seu_PBMC)

P3C <- seu_PBMC@meta.data |> 
  count(cell_type, Condition) |> 
  mutate(dcats = rep(dcats_df$LRT_pvals, each = 2)) |> 
  group_by(cell_type) |> 
  mutate(prop = n / sum(n),
         stars = case_when(
           dcats < 0.001 ~ "***",
           dcats < 0.01 ~ "**",
           dcats < 0.05 ~ "*",
           TRUE ~ "")) |> 
  ggplot(aes(x = cell_type, y = prop * 100, fill = Condition)) +
  geom_col(position = position_dodge()) +
  geom_text(aes(cell_type, label = round(100 * prop)),
            position = position_dodge(.9), vjust = -.2) +
  geom_text(aes(label = stars), 
            position = position_dodge(.9), vjust = -1.5) +
  scale_fill_manual(values = c("#FF8E7BFF", "#009DBDFF")) +
  labs(x = "Cell type", y = "Relative abundance (%)") +
  custom_theme() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        legend.text = element_text(size=rel(1.15)))

# Figure 4C - DEG-upset plot (all cell types)



```


<!-- Panel 4: CD14 monocytes-immunomodulation: imbalance score, Volcano plot of DEGs, pathway analysis (GSEA KEGG, BP), CS-score, Cell Chat, , TF analysis -->

```{r}
# Imbalance score

imb_df <- read_rds("RData/2024-12-09_imbalance_score.rds")

P4A <- ggplot(imb_df, aes(x = umapharmony_1, y = umapharmony_2, col = scores)) +
  geom_point(size = .7) +
  scale_color_viridis_c(option = "D") +
  custom_theme() +
  empty_axis()

# Volcano plot of DEGs

DGE_PBMC <- read_rds("RData/2024-09-26_DGE_sc_res_1.rds")

DGE_PBMC[["CD14 Mono"]] |> 
  mutate(Expression = case_when(
    avg_log2FC >= 2 & p_val_adj <= 0.01 ~ "Upregulated",
    avg_log2FC <= -2 & p_val_adj <= 0.01 ~ "Downregulated",
    TRUE ~ "Not significant")) |>
  ggplot(aes(x = avg_log2FC, y = -log10(p_val_adj + 1e-5))) +
  geom_point(aes(color = Expression)) +
  ggrepel::geom_text_repel(data = head(DGE_PBMC[["CD14 Mono"]][order(DGE_PBMC[["CD14 Mono"]][["p_val_adj"]]),], 10),
                           aes(label = gene)) +
  scale_color_manual(values = c("#FF8E7BFF", "grey", "#009DBDFF")) +
  scale_x_continuous(name = "Log2 fold change") +
  scale_y_continuous(name = "-Log10 padj") +
  geom_hline(yintercept = 2, linetype = 2, color = "black") +
  geom_vline(xintercept = c(-2, 2), linetype = 2, color = "black") +
  custom_theme()



```


<!-- Panel 5: IL-10 producing monocytes: Il-10 levels in FA vs HC, IL-10 pathway genes (Reactome) heatmap, IL-10 producing cells proportion -->
<!-- Panel 6: Neutrophils-IFN signaling: Metascape results, IFN pathway gene heatmap/scores Neutrophil degranulation pathway genes heatmap/ pathway scores, TF-STAT1 signaling, PRR pathway score -->
<!-- Panel 7: Monocyte IL-10- Neutrophil IFN axis associated with cardiomyopathy: WGCNA (bulk)- cardiac hypertrophy/ IL-10 signaling genes; Il-10 levels in CAD vs NCAD, NLR ratio in CAD vs NCAD, Neutrophil genes- KLF2- cardiomyopathy -->















