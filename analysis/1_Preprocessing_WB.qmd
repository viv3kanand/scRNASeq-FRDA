---
title: "1. Preprocessing - scRNA-Seq - FRDA (Whole Blood)"
format: html
editor: source
author: viv3kanand
---

## Package dependencies

```{r}
# renv::install("tidyverse")
# renv::install("Seurat")
# renv::install("gt")
```

### Load required libraries

```{r}
#| echo: false
#| include: false
#| message: false
#| warning: false

require(tidyverse)
require(Seurat)
require(gt)
```

## Process data

### Load data

```{r}
#| echo: true

li_WB <- list.files("../data/WB/")

purrr::imap(setNames(li_WB, li_WB), function(obj, name){
  Seurat::Read10X(paste0("../data/WB/", obj)) |> 
    Seurat::CreateSeuratObject(min.cells = 3,
                               project = name)
}) -> seurat_list

```

### Filter and merge

```{r}
source("../scripts/helper_scripts.R")
```

### Add batch metadata
```{r}
meta <- read.delim(text = "orig.ident	Batch_Lib	Batch_Seq	Condition
C2_Control	1	3	Control
O2_Control	2	3	Control
S2_Control	1	1	Control
S4_Control	4	2	Control
N4_Patient	4	4	Patient
O3_Patient	3	4	Patient
O4_Patient	3	3	Patient
S1_Patient	1	1	Patient
S3_Patient	4	2	Patient
")
```

```{r}
# Filter cells with empirical cut off
seurat_list <- seurat_list |> map(filterCell)

# remove sample failed QC
seurat_list$O3_Patient <- NULL

# Merge datasets
seurat_obj <- reduce(seurat_list, merge) |>
  JoinLayers()  #https://github.com/satijalab/seurat/issues/7316

meta.data <- seurat_obj@meta.data |> 
  merge(meta, by = "orig.ident", all.x = TRUE)

seurat_obj <- seurat_obj |> 
  AddMetaData(metadata = meta.data)
```

### Filtering summary
```{r}
lapply(seurat_list, function(obj){
    emp <- emp_fun(obj)
    filt <- filt_fun(obj, emp)
    emp |> as.data.frame() |> 
        rownames_to_column("Sample") |> 
        mutate(nCount_RNA = round(nCount_RNA),
               nFeature_RNA = round(nFeature_RNA),
               nCells = nrow(obj@meta.data),
               nCells_filt = nrow(filt@meta.data)) |> 
        filter(Sample == 1)
}) |> bind_rows(.id = "Sample") |> 
    gt() |> 
    tab_header(title = "Sample filtering based on following empirical cut off")
```




















